<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chatter - Test</title>
    <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
</head>

<body>
    <div id="alertify" style="position: fixed; right: 0; top: 0">
    </div>

    <div class="login">
        <input type="text" id="email" value="doganderya59@gmail.com"> <br>
        <input type="password" id="pass" value="1">
        <button id="login">login</button>
        <hr>
    </div>

    <div id="createRooms" style="display: none">
        <input type="text" id="name" value="Oda adı"> <br>

        <select id="users" multiple="multiple">
        
        </select>

        <button id="odaolustur">oda olustur</button>
        <hr>
    </div>

    <div id="rooms">

    </div>

    <hr>

    <div id="messages">

    </div>

    <div id="messageSend">

    </div>

    <script>
        var token = null;

        function getPCV(target) {
            return Array.from(target.parentElement.children).map(function (e) { return e.value });
        }
        function post(url, data, fn) {
            var request = new XMLHttpRequest();
            request.open("POST", url, true);
            request.setRequestHeader('Content-Type', 'application/json');
            if (token) {
                request.setRequestHeader('Token', token);
            }
            request.send(JSON.stringify(data));
            request.onreadystatechange = function () {
                if (this.readyState == 4) {
                    console.log(JSON.parse(request.response))
                    fn(JSON.parse(request.response))
                }
            }
        }

        function getSelectValues(select) {
            var result = [];
            var options = select && select.options;
            var opt;

            for (var i = 0, iLen = options.length; i < iLen; i++) {
                opt = options[i];

                if (opt.selected) {
                    result.push(opt.value || opt.text);
                }
            }
            return result;
        }

        function get(url, fn) {
            var request = new XMLHttpRequest();
            request.open("GET", url, true);
            request.setRequestHeader('Content-Type', 'application/json');
            if (token) {
                request.setRequestHeader('Token', token);
            }
            request.send();
            request.onreadystatechange = function () {
                if (this.readyState == 4) {
                    console.log(JSON.parse(request.response))
                    fn(JSON.parse(request.response))
                }
            }
        }

        function alertt(message) {
            var alertifty = document.getElementById('alertify');
            var alert = document.createElement("div");
            alert.style.backgroundColor = "green";
            alert.style.color = "white";
            alert.style.padding = "5px";
            alert.style.margin = "1px";
            alert.style.minWidth = "100px";
            alert.innerText = message;
            alertifty.appendChild(alert);

            alert.timeout = setTimeout(function () {
                alertifty.removeChild(alert);
            }, 2000);

            alert.onmouseenter = function () {
                clearTimeout(alert.timeout);
                alert.timeout = null;
            }

            alert.onmouseleave = function () {
                if (!alert.timeout) {
                    alert.timeout = setTimeout(function () {
                        alertifty.removeChild(alert);
                    }, 2000);

                }
            }
        }

        document.getElementById('login').onclick = function (e) {
            var values = getPCV(e.currentTarget);
            post("/v1/login", {
                email: values[0],
                password: values[2]
            }, function (r) {
                token = r.code;
                document.getElementById('createRooms').style.display = 'block';
                get("/v1/user/random", function (users) {
                    var udom = document.getElementById('users');
                    udom.innerHTML = users.map(function (user) {
                        return god('<option value=":id">:name</option>', user);
                    }).join("\n");
                });

                socket = io.connect();
                socket.on('message', function (message) {
                    if (message.room.id == activeRoom) {
                        var rmes = document.getElementById('messages');
                        message.user = message.user.name;
                        rmes.innerHTML += god('<div class="message">:user => :content</div>', message);
                    } else {
                        message.room = message.room.name;
                        message.user = message.user.name;
                        alertt(god(':room - :user => :content', message));
                    }
                });

                socket.emit('alive', {
                    token: token,
                    userId: r.ownerId
                });

                renderRooms();
            })
        }

        function god(txt, obj) {
            return txt.replace(/:(\w+)/g, function (all, word) {
                return obj[word];
            });
        }

        function renderRooms() {
            var rdom = document.getElementById("rooms");
            get("/v1/room/active", function (rooms) {
                rdom.innerHTML = rooms.map(function (room) {
                    return god('<div class="room">:name <button onclick="roomgo(\':id\')">gir</button></div>', room);
                }).join("\n");
            })
        }

        var socket;
        var activeRoom;
        function roomgo(room) {
            var rmes = document.getElementById('messages');
            get('/v1/message/list/' + room, function (messages) {

                rmes.innerHTML = messages.map(function (message) {
                    message.user = message.user.name;
                    return god('<div class="message">:user => :content</div>', message);
                }).join("\n");

                document.getElementById('messageSend').innerHTML = '<input id="mgonder"><button id="mesgonder">Mesaj gönder</button>';
                document.getElementById('mesgonder').onclick = mesgonder;
                activeRoom = room;
            });
        }

        document.getElementById('odaolustur').onclick = function (e) {
            var values = getPCV(e.currentTarget);
            var rdom = document.getElementById("rooms");
            post('/v1/room/create', {
                name: values[0],
                participants: getSelectValues(document.getElementById('users')).map(function (id) {
                    return { id: id };
                })
            }, function (room) {
                rdom.innerHTML += god('<div class="room">:name <button onclick="roomgo(\':id\')">gir</button></div>', room);
            })
        }

        function mesgonder() {
            var message = document.getElementById('mgonder').value;
            socket.emit('message', {
                message: message,
                room: activeRoom
            });
            document.getElementById('mgonder').value = "";
        }
    </script>


</body>

</html>